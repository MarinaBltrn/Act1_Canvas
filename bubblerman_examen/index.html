<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubblerman</title>

    <style>
        canvas {
            background-color: black;
        }
    </style>
</head>

<body>
    <center>
        <canvas width="1500" height="1500px" id="my_canvas"></canvas>
    </center>
    <script>
        var canvas = document.getElementById('my_canvas');
        var ctx = canvas.getContext('2d');
        var dir = 0;
        var speed = 5;
        var pause = false;
        let score = 0;
        let walls = [];
        let pasteles = [];
        let bombasColocadas = [];
        let pastelesRecogidos = 0;
        var tiempoEspera = 2;
        var personajePuedeMoverse = false;
        var tecla_presionada = {
            w: false,
            s: false,
            a: false,
            d: false
        };
        let objetoX, objetoY;
        let dir_player = "reposo";

        let image = new Image();
        image.src = "player_reposo-copia.png";

        let image2 = new Image();
        image2.src = "arriba/p_arriba-copia.png";

        let image3 = new Image();
        image3.src = "abajo/p_abajo-copia.png";

        let image4 = new Image();
        image4.src = "derecha/p_der-copia.png";

        let image5 = new Image();
        image5.src = "izquierda/p_izq-copia.png";

        let image6 = new Image();
        image6.src = "textura_pared.png";

        let imagenPastel = new Image();
        imagenPastel.src = "pastel.png";

        let ambiental = new Audio("musica/ambiental_Bubblerman.mp3");
        ambiental.volume = 0.3;

        let game_pause = new Audio("musica/player_pause.mp3");
        game_pause.volume = 0.3;

        let comer_pastel = new Audio("musica/player_pastel.mp3");
        comer_pastel.volume = 0.3;

        // Clase para crear y pintar objetos.
        class rectangulo {
            constructor(x, y, w, h, color) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.color = color;
            }
            pintarRectangulo(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
                //ctx.strokeRect(this.x, this.y, this.w, this.h);
                ctx.drawImage(image6, this.x, this.y, this.w, this.h);

            }
            // Verificar si chocan los objetos.
            seTocan(target) {
                if (this.x < target.x + target.w &&
                    this.x + this.w > target.x &&
                    this.y < target.y + target.h &&
                    this.y + this.h > target.y) {
                    return true;
                }
                return false;
            }
        }

        class pastel {
            constructor(x, y, w, h) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.visible = true;
            }
            dibujar(ctx) {
                if (this.visible) {
                    ctx.drawImage(imagenPastel, this.x, this.y, this.w, this.h);
                }
            }
        }

        class generarBomba {
            constructor(x, y, w, h, color, areaDeExplosion) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.color = color;
                this.vida = 2; // Tiempo de vida en segundos
                this.explotando = false;
                this.areaDeExplosion = areaDeExplosion;
                this.dañadoJugador = false;
            }

            actualizar() {
                if (!this.explotando) {
                    this.vida -= 1 / 60; // Resta tiempo en segundos (60 cuadros por segundo)
                    if (this.vida <= 0) {
                        this.explotando = true;

                    }
                }
            }

            dibujarBomba(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
            }

            bombaExplota() {
                if (this.explotando && !this.dañadoJugador) { // verificar que la bomba explotó sin hacerle daño al jugador.
                    const index = bombasColocadas.indexOf(this);
                    if (index !== -1) {
                        bombasColocadas.splice(index, 1);
                    }
                    // Verificar la distancia del jugador a la bomba
                    const distanciaJugador = Math.sqrt(Math.pow(player.x - this.x, 2) + Math.pow(player.y - this.y, 2));

                    if (distanciaJugador <= this.areaDeExplosion) {
                        // Verificar si el jugador está dentro del área de explosión
                        score -= 10;
                        this.dañadoJugador = true;
                    }
                }
            }
        }



        // Generamos los pasteles manualmente en las coordenadas indicadas
        // Coordenadas en el eje X
        const coordenadasX = [310, 510, 710, 910, 1110, 1310];

        // Coordenadas en el eje Y 
        const coordenadaY = [110, 210, 310, 410, 510, 610, 710, 810, 910, 1010, 1110, 1210, 1310];

        // Función para generar un pastel en una coordenada aleatoria
        function generarPastelAleatorio() {
            const coordenadaXAleatoria = coordenadasX[Math.floor(Math.random() * coordenadasX.length)];
            const coordenadaYAleatoria = coordenadasX[Math.floor(Math.random() * coordenadasX.length)];
            const objetoAncho = 70;
            const objetoAlto = 70;

            // Crea un pastel en la coordenada aleatoria
            pasteles.push(new pastel(coordenadaXAleatoria, coordenadaYAleatoria, objetoAncho, objetoAlto));
        }

        for (let i = 0; i < 6; i++) {
            generarPastelAleatorio();
        }

        const player = new rectangulo(110, 110, 64, 64, random_rgba());
        const target = new rectangulo(420, 380, 40, 40, "black"); // huesoooo

        let aum_lateral = 0;
        let aum_inferior = 1400;
        let aum_superior = 0;
        for (let x = 0; x <= 30; x++) {
            walls.push(new rectangulo(aum_lateral, aum_superior, 100, 100, "#0092A0"));
            walls.push(new rectangulo(aum_lateral, aum_inferior, 100, 100, "#0092A0"));
            aum_lateral += 100;
            x++;
        }

        let aum_izq = 0;
        let aum_der = 1400;
        let aum_vertical = 0;
        for (let y = 0; y <= 28; y++) {
            walls.push(new rectangulo(aum_izq, aum_vertical, 100, 100, "#0092A0"));
            walls.push(new rectangulo(aum_der, aum_vertical, 100, 100, "#0092A0"));
            aum_vertical += 100;
            y++;
        }

        let map_lateral = 200;
        let map_vertical = 200;

        for (let i = 0; i <= 5; i++) {
            for (let j = 0; j <= 5; j++) {
                if (j % 2 == 0) {
                    walls.push(new rectangulo(map_lateral, map_vertical, 100, 100, "#0092A0"));
                    map_lateral += 200;
                } else {
                    walls.push(new rectangulo(map_lateral, map_vertical, 100, 100, "#0092A0"));
                    map_lateral += 200;
                }
            }
            switch (i) {
                case 0:
                    map_vertical = 200;
                    break;
                case 1:
                    map_vertical = 400;
                    break;
                case 2:
                    map_vertical = 600;
                    break;
                case 3:
                    map_vertical = 800;
                    break;
                case 4:
                    map_vertical = 1000;
                    break;
            }
            map_lateral = 200;
            map_vertical += 200;
        }


        document.addEventListener('keydown', (event) => {
            console.log(event);

            switch (event.keyCode) {
                case 87:
                    if (!pause) {
                        dir = event.keyCode;
                        dir_player = "arriba";
                        tecla_presionada.w = true;
                    }
                    break;
                case 83:
                    if (!pause) {
                        dir = event.keyCode;
                        dir_player = "abajo";
                        tecla_presionada.s = true;
                    }
                    break;
                case 65:
                    if (!pause) {
                        dir = event.keyCode;
                        dir_player = "izquierda";
                        tecla_presionada.a = true;
                    }
                    break;
                case 68:
                    if (!pause) {
                        dir = event.keyCode;
                        dir_player = "derecha";
                        tecla_presionada.d = true;
                    }
                    break;
                case 32:
                    if (!pause) {
                        const bomba = new generarBomba(player.x, player.y, 40, 40, 'blue', 100); // Cambia el valor 100 al tamaño de área de explosión deseado.
                        bombasColocadas.push(bomba);
                        console.log("Bomba creada en X:", player.x, "Y:", player.y);
                    }
                    break;
                case 80:
                    pause = !pause;
                    if (pause) {
                        game_pause.play();
                    }
                    break;
            }
        });
        document.addEventListener('keyup', (event) => {
            switch (event.keyCode) {
                case 87:
                    tecla_presionada.w = false;
                    break;
                case 83:
                    tecla_presionada.s = false;
                    break;
                case 65:
                    tecla_presionada.a = false;
                    break;
                case 68:
                    tecla_presionada.d = false;
                    break;
            }
        });

        let dañoAlJugador = false;
        function update() {
            //ambiental.play(); // RECUERDA ACTIVARLO PARA LA ENTREGA
            if (tiempoEspera > 0) {
                tiempoEspera -= 1 / 60; // Resta 1 segundo cada 60 cuadros por segundo
            } else {
                personajePuedeMoverse = true;
            }

            if (personajePuedeMoverse) {
                if (!pause) {
                    if (tecla_presionada.w) {
                        player.y -= speed;
                        if (player.y < -50) {
                            player.y = 1480;
                        }
                    } else if (tecla_presionada.s) {
                        player.y += speed;
                        if (player.y > 1480) {
                            player.y = -50;
                        }
                    } else if (tecla_presionada.a) {
                        player.x -= speed;
                        if (player.x < -50) {
                            player.x = 1480;
                        }
                    } else if (tecla_presionada.d) {
                        player.x += speed;
                        if (player.x > 1480) {
                            player.x = -50;
                        }
                    } else {
                        dir_player = "reposo";
                    }

                    for (let i = 0; i < pasteles.length; i++) {
                        const objeto = pasteles[i];
                        if (objeto.visible && player.seTocan(objeto)) {
                            objeto.visible = false;
                            comer_pastel.play();
                            score += 10;
                            speed += 0.3;
                        }
                    }

                    // Topa con la colisión de la pared.
                    for (var i = walls.length - 1; i >= 0; i--) {
                        if (tecla_presionada.w && player.seTocan(walls[i])) {
                            player.y += speed;
                        }
                        if (tecla_presionada.s && player.seTocan(walls[i])) {
                            player.y -= speed;
                        }
                        if (tecla_presionada.a && player.seTocan(walls[i])) {
                            player.x += speed;
                        }
                        if (tecla_presionada.d && player.seTocan(walls[i])) {
                            player.x -= speed;
                        }
                    }

                    for (const bomba of bombasColocadas) {
                        bomba.actualizar();
                        bomba.bombaExplota();
                    }
                    if (!dañoAlJugador) {
                        for (const bomba of bombasColocadas) {
                            // Calcular la distancia entre el jugador y la bomba usando el teorema de Pitágoras
                            const distanciaX = bomba.x - player.x;
                            const distanciaY = bomba.y - player.y;
                            const distancia = Math.sqrt(distanciaX * distanciaX + distanciaY * distanciaY);

                            // Compara la distancia con el radio del área de explosión de la bomba
                            if (distancia <= bomba.areaDeExplosion) {
                                score -= 10;
                                dañoAlJugador = true; // Marcar al jugador como dañado para este cuadro
                            }
                        }
                    }
                }
            }
            repaint();
            window.requestAnimationFrame(update);
        }

        function repaint() {
            if (!pause) {

                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, 1500, 1500);
                switch (dir_player) {
                    case "arriba":
                        ctx.drawImage(image2, player.x, player.y, 50, 70);
                        break;
                    case "abajo":
                        ctx.drawImage(image3, player.x, player.y, 50, 70);
                        break;
                    case "izquierda":
                        ctx.drawImage(image5, player.x, player.y, 50, 70);
                        break;
                    case "derecha":
                        ctx.drawImage(image4, player.x, player.y, 50, 70);
                        break;
                    default:
                        ctx.drawImage(image, player.x, player.y, 50, 70);
                        break;
                }

                for (const objeto of pasteles) {
                    if (objeto.visible) {
                        objeto.dibujar(ctx);
                    }
                }

                for (var i = walls.length - 1; i >= 0; i--) {
                    walls[i].pintarRectangulo(ctx);
                }

                for (const bomba of bombasColocadas) {
                    bomba.dibujarBomba(ctx);
                }
                ctx.fillStyle = 'black'; // Establece el color del texto
                ctx.font = '50px Arial'; // Establece la fuente y el tamaño del texto
                ctx.fillText('Puntuación: ' + score, 100, 60);
            } else {

            }
        }
        // Dejarlo por si necesito ver el espacio del jugador
        function random_rgba() {
            var o = Math.round, r = Math.random, s = 255;
            return 'rgba(' + o(r() * s) + ',' + o(r() * s) + ',' + o(r() * s) + ',' + r().toFixed(1) + ')';
        }

        window.requestAnimationFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 17);
                };
        }());

        window.requestAnimationFrame(update);

    </script>
</body>

</html>